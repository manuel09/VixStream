<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VixStream - Guarda Film e Serie TV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="https://img.icons8.com/color/48/000000/netflix--v1.png" type="image/x-icon">

    <style>
        /* Stili globali */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: #1a202c; /* Corrisponde a bg-gray-900 di Tailwind */
            color: #e2e8f0; /* Corrisponde a text-gray-100 di Tailwind */
            overflow-x: hidden; /* Evita scroll orizzontale non voluto */
        }

        /* Nascondi la scrollbar ma mantieni la funzionalità di scorrimento */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none; /* IE e Edge */
            scrollbar-width: none; /* Firefox */
        }

        /* Header */
        header {
            background: rgba(26, 32, 44, 0.8); /* Sfondo semi-trasparente */
            backdrop-filter: blur(8px); /* Effetto sfocato */
            -webkit-backdrop-filter: blur(8px); /* Per compatibilità Safari */
        }

        .nav-link.active {
            color: #dc2626; /* red-600 */
            font-weight: bold;
        }

        /* Hero Section */
        #hero {
            min-height: 500px; /* Altezza minima per l'hero */
        }

        /* Card nei caroselli e griglie */
        .card {
            min-width: 120px; /* Base più piccola per schermi molto stretti */
            width: 120px;
            height: 180px; /* Altezza proporzionale (120 * 1.5) */
            aspect-ratio: 2 / 3; /* Proporzioni standard di una locandina */
            flex-shrink: 0; /* Impedisce che le card si restringano */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-right: 0.75rem; /* Spazio ridotto tra le card (12px) */
            box-sizing: border-box; /* Essenziale per la gestione delle dimensioni */
            position: relative; /* Necessario per il posizionamento dell'overlay */
            overflow: hidden; /* Assicura che l'overlay non esca dai bordi */
        }

        .card:last-child {
            margin-right: 0;
        }

        .card:hover {
            transform: scale(1.05); /* Zoom leggero al passaggio del mouse */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4); /* Ombra più pronunciata */
            z-index: 10; /* Per evitare che le ombre si sovrappongano alle card adiacenti in modo strano */
        }

        .card img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Assicura che l'immagine copra l'intera area */
            border-radius: 0.5rem; /* Corrisponde a rounded-lg di Tailwind */
        }

        .card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0));
            color: white;
            padding: 0.75rem;
            font-size: 0.9rem;
            font-weight: bold;
            opacity: 0; /* Nascosto di default */
            transition: opacity 0.3s ease;
            text-align: center;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }

        .card:hover .card-overlay {
            opacity: 1; /* Mostra al passaggio del mouse */
        }

        /* Responsive per le card - Dimensioni progressive */
        @media (min-width: 640px) { /* sm */
            .card {
                min-width: 140px;
                width: 140px;
                height: 210px;
                margin-right: 1rem; /* Aumenta lo spazio per schermi più grandi */
            }
        }
        @media (min-width: 768px) { /* md */
            .card {
                min-width: 160px;
                width: 160px;
                height: 240px;
                margin-right: 1.25rem;
            }
        }
        @media (min-width: 1024px) { /* lg */
            .card {
                min-width: 180px;
                width: 180px;
                height: 270px;
                margin-right: 1.5rem;
            }
        }
        @media (min-width: 1280px) { /* xl */
            .card {
                min-width: 190px;
                width: 190px;
                height: 285px;
                margin-right: 1.75rem;
            }
        }

        /* Caroselli - Essenziale per la spaziatura interna e per evitare tagli */
        .carousel-track {
            -webkit-overflow-scrolling: touch; /* Migliora lo scorrimento su iOS */
            scroll-snap-type: x mandatory; /* Per uno scorrimento più "a scatto" (opzionale) */
            padding: 0.5rem 1rem; /* Aggiunge padding interno ai lati del carosello */
            margin-left: -1rem; /* Compensazione per il padding del contenitore principale */
            margin-right: -1rem; /* Compensazione per il padding del contenitore principale */
        }

        .carousel-track .card {
            scroll-snap-align: start; /* Allinea le card all'inizio dello scorrimento */
        }

        .scroll-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            z-index: 20;
            transition: background-color 0.3s ease;
        }

        .scroll-button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .scroll-button.left {
            left: 10px;
        }

        .scroll-button.right {
            right: 10px;
        }

        /* Assicurati che il contenitore delle sezioni abbia un padding laterale appropriato */
        #sections,
        #movieCarousels,
        #tvShowCarousels,
        #searchResults {
            padding-left: 1rem; /* 16px */
            padding-right: 1rem; /* 16px */
        }

        /* Per la griglia dei risultati di ricerca, il gap è gestito da Tailwind, ma un controllo non fa male */
        #resultsGrid,
        #movieGenresGrid,
        #tvShowGenresGrid {
            gap: 1.25rem;
        }

        /* Modal Info */
        .info-modal-container {
            max-width: 960px;
            width: 90%;
            height: 90vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .info-modal-bg-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            filter: brightness(0.5);
        }

        .info-modal-gradient {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, #1a202c 0%, rgba(26, 32, 44, 0.9) 30%, transparent 60%);
            z-index: 1;
        }

        .info-modal-content-container {
            position: relative;
            z-index: 10;
            padding-top: 10%;
            flex-grow: 1;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .info-modal-content-container::-webkit-scrollbar {
            display: none;
        }

        .info-poster {
            width: 250px;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.6);
            margin-top: -30px;
            flex-shrink: 0;
        }

        .info-poster-mobile {
            width: 150px;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            margin-bottom: 1rem;
            margin-top: -50px;
        }

        @media (max-width: 767px) {
            .info-modal-content-container {
                flex-direction: column;
                align-items: center;
                text-align: center;
                padding-top: 70%;
            }

            .info-modal-bg-img {
                height: 50%;
            }

            .info-poster {
                display: none;
            }
            .info-poster-mobile {
                display: block;
                margin-top: -60px;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans scrollbar-hide">
    <header class="fixed top-0 left-0 w-full z-50 bg-gradient-to-b from-gray-900 to-transparent p-4 flex items-center justify-between backdrop-blur-sm">
        <div class="flex items-center">
            <a href="#" id="homeLink" class="text-red-600 text-4xl font-extrabold mr-8 hover:text-red-700 transition-colors">VixStream</a>
            <nav class="hidden md:flex space-x-6 text-lg">
                <a href="#" id="moviesLink" class="nav-link text-gray-300 hover:text-white transition-colors">Film</a>
                <a href="#" id="tvShowsLink" class="nav-link text-gray-300 hover:text-white transition-colors">Serie TV</a>
            </nav>
        </div>
        <div class="relative">
            <input type="text" id="searchInput" placeholder="Cerca film o serie TV..."
                           class="bg-gray-800 text-gray-100 rounded-full py-2 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-red-600 transition-all duration-300 w-48 md:w-64">
            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
    </header>

    <main class="pt-24 pb-8 min-h-screen">
        <section id="homepageSection" class="section active">
            <div id="hero" class="relative h-[60vh] md:h-[80vh] bg-cover bg-center flex items-end p-8 md:p-16 rounded-xl overflow-hidden mb-12 hidden">
                <img id="heroImg" src="" alt="Hero Background" class="absolute inset-0 w-full h-full object-cover z-0">
                <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/60 to-transparent z-10"></div>
                <div class="relative z-20 text-white max-w-xl">
                    <h1 id="heroTitle" class="text-4xl md:text-6xl font-extrabold drop-shadow-lg mb-4"></h1>
                    <p id="heroOverview" class="text-base md:text-lg mb-6 line-clamp-3"></p>
                    <button id="heroPlay" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full text-lg transition-colors duration-300 flex items-center shadow-lg" aria-label="Guarda ora">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        Guarda ora
                    </button>
                </div>
            </div>

            <div id="sections" class="container mx-auto px-4 space-y-12">
                </div>
        </section>

        <section id="moviesSection" class="section hidden">
            <div class="container mx-auto px-4">
                <h2 class="text-4xl font-extrabold text-white mb-8">Film</h2>
                <div id="movieGenresGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 mb-12">
                    </div>
                <div id="movieCarousels" class="space-y-12">
                    </div>
            </div>
        </section>

        <section id="tvShowsSection" class="section hidden">
            <div class="container mx-auto px-4">
                <h2 class="text-4xl font-extrabold text-white mb-8">Serie TV</h2>
                <div id="tvShowGenresGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 mb-12">
                    </div>
                <div id="tvShowCarousels" class="space-y-12">
                    </div>
            </div>
        </section>

        <section id="searchResults" class="section hidden">
            <div class="container mx-auto px-4">
                <h2 class="text-4xl font-extrabold text-white mb-8">Risultati di Ricerca</h2>
                <div id="resultsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                    </div>
                <div class="flex justify-center mt-12">
                    <button id="loadMoreResults" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full text-lg transition-colors duration-300 shadow-lg hidden">
                        Carica Altri
                    </button>
                </div>
            </div>
        </section>
    </main>

    <div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-75 z-[90] hidden" aria-hidden="true"></div>

    <div id="infoModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <div class="info-modal-container bg-gray-800 rounded-lg shadow-2xl relative overflow-hidden transform scale-95 md:scale-100 transition-all duration-300 w-full max-w-4xl max-h-[90vh] overflow-y-auto scrollbar-hide">
            <img id="infoBgImg" src="" alt="Background Image" class="info-modal-bg-img">
            <div class="info-modal-gradient"></div>

            <button id="closeInfo" class="absolute top-4 right-4 bg-gray-700 hover:bg-gray-600 text-white rounded-full p-2 z-20 transition-colors" aria-label="Chiudi informazioni">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <div class="relative z-10 info-modal-content-container p-6 md:p-10 flex flex-col md:flex-row items-center md:items-start gap-6">
                <img id="infoPoster" src="" alt="Poster" class="info-poster hidden md:block">
                <img id="infoPosterMobile" src="" alt="Poster" class="info-poster-mobile block md:hidden w-40 h-auto rounded-lg shadow-lg">

                <div class="flex-1 text-white">
                    <h2 id="infoTitle" class="text-3xl md:text-4xl font-bold mb-3 drop-shadow-lg text-center md:text-left"></h2>
                    <p id="infoMeta" class="text-gray-300 text-sm md:text-base mb-4 text-center md:text-left"></p>
                    <p id="infoOverview" class="text-gray-200 text-base md:text-lg mb-6 line-clamp-5"></p>

                    <div id="tvSelectors" class="flex flex-col sm:flex-row gap-4 mb-6 hidden">
                        <div>
                            <label for="seasonSelect" class="block text-gray-300 text-sm font-semibold mb-2">Stagione:</label>
                            <select id="seasonSelect" class="bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 transition-colors">
                                </select>
                        </div>
                        <div>
                            <label for="episodeSelect" class="block text-gray-300 text-sm font-semibold mb-2">Episodio:</label>
                            <select id="episodeSelect" class="bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 transition-colors">
                                </select>
                        </div>
                    </div>

                    <div class="flex justify-center md:justify-start">
                        <button id="playBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full text-lg transition-colors duration-300 flex items-center shadow-lg" aria-label="Riproduci">
                            <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            Riproduci
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="playerModal" class="fixed inset-0 z-[110] hidden items-center justify-center p-4 bg-black bg-opacity-95">
        <div class="relative w-full h-full max-w-7xl max-h-[90vh]">
            <button id="closePlayer" class="absolute -top-10 right-0 bg-gray-700 hover:bg-gray-600 text-white rounded-full p-2 z-20 transition-colors" aria-label="Chiudi riproduttore">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <iframe id="playerFrame" class="w-full h-full rounded-lg shadow-2xl" frameborder="0" allowfullscreen></iframe>
        </div>
    </div>

    <div id="messageModal" class="fixed inset-0 z-[120] hidden items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-6 text-center max-w-sm w-full relative">
            <h3 id="messageModalTitle" class="text-2xl font-bold text-white mb-4"></h3>
            <p id="messageModalText" class="text-gray-300 mb-6"></p>
            <button id="closeMessageModal" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full transition-colors duration-300">
                OK
            </button>
        </div>
    </div>

    <script>
        // --- CONFIGURAZIONE GLOBALE ---
        // !!! IMPORTANTE: SOSTITUISCI QUESTO CON LA TUA CHIAVE REALE DI TMDB! !!!
        const TMDB_KEY = "7c6df7a1b0b016561e6c2dcd26ecf711";
        const TMDB_API_BASE_URL = "https://api.themoviedb.org/3";
        const TMDB_IMAGE_BASE_URL = "https://image.tmdb.org/t/p/";
        const VID_DOMAIN = "vixsrc.to"; // Dominio per lo streaming

        // --- RIFERIMENTI AGLI ELEMENTI DOM ---
        const homeLink = document.getElementById("homeLink");
        const moviesLink = document.getElementById("moviesLink");
        const tvShowsLink = document.getElementById("tvShowsLink");
        const navLinks = document.querySelectorAll(".nav-link");

        const homepageSection = document.getElementById("homepageSection");
        const moviesSection = document.getElementById("moviesSection");
        const tvShowsSection = document.getElementById("tvShowsSection");
        const searchSection = document.getElementById("searchResults");
        const sectionsEl = document.getElementById("sections"); // Contenitore per i caroselli nella homepage

        const hero = document.getElementById("hero");
        const heroImg = document.getElementById("heroImg");
        const heroTitle = document.getElementById("heroTitle");
        const heroOverview = document.getElementById("heroOverview");
        const heroPlay = document.getElementById("heroPlay");

        const movieCarouselsContainer = document.getElementById("movieCarousels");
        const movieGenresGrid = document.getElementById("movieGenresGrid");
        const tvShowCarouselsContainer = document.getElementById("tvShowCarousels");
        const tvShowGenresGrid = document.getElementById("tvShowGenresGrid");

        const searchInput = document.getElementById("searchInput");
        const resultsGrid = document.getElementById("resultsGrid");
        const loadMoreResultsBtn = document.getElementById("loadMoreResults");

        const modalBackdrop = document.getElementById("modalBackdrop");
        const infoModal = document.getElementById("infoModal");
        const infoBgImg = document.getElementById("infoBgImg");
        const infoPoster = document.getElementById("infoPoster");
        const infoPosterMobile = document.getElementById("infoPosterMobile");
        const infoTitle = document.getElementById("infoTitle");
        const infoMeta = document.getElementById("infoMeta");
        const infoOverview = document.getElementById("infoOverview");
        const playBtn = document.getElementById("playBtn");
        const closeInfoBtn = document.getElementById("closeInfo"); // Aggiunto per il pulsante di chiusura del modal info

        const playerModal = document.getElementById("playerModal");
        const playerFrame = document.getElementById("playerFrame");
        const closePlayerBtn = document.getElementById("closePlayer"); // Aggiunto per il pulsante di chiusura del modal player

        const messageModal = document.getElementById("messageModal");
        const messageModalTitle = document.getElementById("messageModalTitle");
        const messageModalText = document.getElementById("messageModalText");
        const closeMessageModalBtn = document.getElementById("closeMessageModal");

        const tvSelectors = document.getElementById("tvSelectors");
        const seasonSelect = document.getElementById("seasonSelect");
        const episodeSelect = document.getElementById("episodeSelect");

        // --- VARIABILI DI STATO GLOBALE ---
        let currentTvSeriesDetails = null;
        let heroItem = null;
        let currentSearchQuery = '';
        let currentSearchPage = 1;
        let totalSearchPages = 1;
        let searchTimeout;

        // --- LISTENER PER IL CAMBIO DI STAGIONE (NEL MODAL INFO) ---
        seasonSelect.onchange = () => {
            console.log("DEBUG VixStream: Stagione cambiata a:", seasonSelect.value);
            const currentItem = JSON.parse(infoModal.dataset.currentItem || '{}');
            if (currentItem && currentItem.media_type === 'tv' && seasonSelect.value) {
                fetchEpisodesForSeason(currentItem.id, parseInt(seasonSelect.value));
            }
        };

        // --- FUNZIONI DI UTILITÀ PER I MODAL ---

        /**
         * Mostra un modal (player, info, message) e il suo sfondo.
         * Impedisce lo scorrimento del body.
         * @param {HTMLElement} modalElement - L'elemento del modal da mostrare.
         */
        function openModal(modalElement) {
            modalBackdrop.classList.remove('hidden');
            modalElement.classList.remove('hidden');
            modalElement.classList.add('flex'); // Assicurati che sia flex per centrare
            document.body.style.overflow = 'hidden'; // Impedisce lo scorrimento del body
            console.log(`DEBUG VixStream: Modal aperto: ${modalElement.id}`);
        }

        /**
         * Nasconde tutti i modal e il suo sfondo, ripristinando lo scorrimento del body.
         */
        function closeAllModals() {
            [infoModal, playerModal, messageModal].forEach(modal => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });
            modalBackdrop.classList.add('hidden');
            document.body.style.overflow = ''; // Ripristina lo scorrimento del body
            console.log("DEBUG VixStream: Tutti i modal chiusi.");
        }

        /**
         * Mostra un modal di messaggio con un titolo e un testo.
         * @param {string} title - Il titolo del messaggio.
         * @param {string} text - Il corpo del messaggio.
         */
        function showMessageModal(title, text) {
            messageModalTitle.textContent = title;
            messageModalText.textContent = text;
            openModal(messageModal);
            console.warn("DEBUG VixStream: Messaggio Modale Mostrato:", title, text);
        }

        /**
         * Pulisce la griglia dei risultati di ricerca.
         */
        function clearSearchResults() {
            resultsGrid.innerHTML = '';
            loadMoreResultsBtn.classList.add('hidden');
            currentSearchPage = 1;
            totalSearchPages = 1;
            console.log("DEBUG VixStream: Risultati di ricerca puliti.");
        }

        /**
         * Funzione per nascondere tutte le sezioni e mostrare quella desiderata.
         * Gestisce anche l'attivazione dei link di navigazione.
         * @param {HTMLElement} sectionToShow - La sezione da mostrare.
         * @param {HTMLElement} [activeLink=null] - Il link di navigazione da attivare (opzionale).
         */
        function showSection(sectionToShow, activeLink = null) {
            // Nascondi tutte le sezioni principali
            homepageSection.classList.add("hidden");
            moviesSection.classList.add("hidden");
            tvShowsSection.classList.add("hidden");
            searchSection.classList.add("hidden");

            // Mostra la sezione desiderata
            sectionToShow.classList.remove("hidden");

            // Rimuovi la classe 'active' da tutti i link di navigazione
            navLinks.forEach(link => link.classList.remove("active"));
            // Aggiungi la classe 'active' al link di navigazione specificato, se fornito
            if (activeLink) {
                activeLink.classList.add("active");
            }
            console.log("DEBUG VixStream: Sezione mostrata:", sectionToShow.id);
            // Scrolla in cima alla sezione
            sectionToShow.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /**
         * Costruisce l'URL per l'iframe del player di vixsrc.to.
         * @param {object} item - L'oggetto film o serie TV (deve avere id e media_type/type).
         * @param {number} [seasonNum=null] - Numero della stagione (solo per serie TV).
         * @param {number} [episodeNum=null] - Numero dell'episodio (solo per serie TV).
         * @returns {object|null} Un oggetto con url e type ('iframe'), o null se non è valido.
         */
        function buildPlayerSrc(item, seasonNum = null, episodeNum = null) {
            let url = '';

            if (item.media_type === 'movie') {
                url = `https://${VID_DOMAIN}/movie/${item.id}?&lang=it`;
            } else if (item.media_type === 'tv') {
                if (seasonNum === null || episodeNum === null) {
                    showMessageModal("Errore", "Per le serie TV devi selezionare stagione ed episodio.");
                    console.error("DEBUG VixStream: Stagione o episodio mancanti per serie TV.");
                    return null;
                }
                url = `https://${VID_DOMAIN}/tv/${item.id}/${seasonNum}/${episodeNum}?&lang=it`;
            } else {
                showMessageModal("Errore", "Tipo di contenuto non supportato per la riproduzione.");
                console.error("DEBUG VixStream: Tipo di contenuto sconosciuto per la riproduzione:", item.media_type);
                return null;
            }
            return { url, type: 'iframe' };
        }

        /**
         * Funzione per creare una card (miniatura) per film/serie TV.
         * @param {object} item - Dettagli del film o della serie TV.
         * @returns {HTMLElement|null} La card creata o null se non ha un poster.
         */
        function createCard(item) {
            // Salta gli elementi senza un'immagine poster o senza un titolo/nome
            if (!item.poster_path && !item.backdrop_path || (!item.title && !item.name)) return null;
        
            // Determina il media_type in modo più robusto
            let itemMediaType = item.media_type;
            if (!itemMediaType) {
                if (item.title) {
                    itemMediaType = 'movie';
                } else if (item.name) {
                    itemMediaType = 'tv';
                } else {
                    console.warn("DEBUG VixStream: Impossibile determinare media_type per l'elemento (né title, né name):", item);
                    return null; // Non creare la card se non possiamo determinarne il tipo
                }
            }

            const card = document.createElement('div');
            card.className = 'card relative rounded-lg overflow-hidden shadow-lg cursor-pointer';
            card.dataset.id = item.id;
            // !!! CORREZIONE CHIAVE: Assicurati che il dataset.mediaType sia sempre corretto !!!
            card.dataset.mediaType = itemMediaType; 

            const img = document.createElement('img');
            img.src = `${TMDB_IMAGE_BASE_URL}w500${item.poster_path || item.backdrop_path}`; // Usa backdrop se poster non disponibile
            img.alt = item.title || item.name;
            img.loading = 'lazy'; // Migliora le prestazioni di caricamento

            const overlay = document.createElement('div');
            overlay.className = 'card-overlay';
            overlay.textContent = item.title || item.name;

            card.appendChild(img);
            card.appendChild(overlay);

            card.addEventListener('click', () => {
                // !!! CORREZIONE CHIAVE: Passa un oggetto con il media_type garantito !!!
                showInfoModal({ ...item, media_type: itemMediaType }); 
            });

            return card;
        }

        /**
         * Funzione generica per fare richieste all'API di TMDb.
         * @param {string} path - Il percorso dell'API (es. "/trending/all/week").
         * @param {object} [params={}] - Oggetto di parametri aggiuntivi per la query string.
         * @returns {Promise<object>} I dati della risposta JSON.
         */
        async function fetchData(path, params = {}) {
            const urlParams = new URLSearchParams({
                api_key: TMDB_KEY,
                language: 'it-IT', // Per ottenere i dettagli in italiano
                ...params
            });
            const url = `${TMDB_API_BASE_URL}${path}?${urlParams.toString()}`;

            console.log(`DEBUG VixStream: Fetching: ${url}`);
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("DEBUG VixStream: Errore API:", response.status, errorData);
                    // Gestione specifica per errore 401 (chiave API non valida)
                    if (response.status === 401) {
                        showMessageModal("Errore Chiave API", "La tua chiave TMDB API non è valida o non è stata configurata correttamente. Controlla il codice.");
                    } else {
                        showMessageModal("Errore di Rete", `Impossibile caricare i dati: ${errorData.status_message || 'Errore sconosciuto'}`);
                    }
                    throw new Error(`TMDb API error: ${response.status} - ${errorData.status_message || 'Errore sconosciuto'}`);
                }
                return await response.json();
            } catch (error) {
                console.error("DEBUG VixStream: Errore fetch:", error);
                // Evita di mostrare un doppio modal se l'errore 401 è già stato gestito sopra
                if (!error.message.includes("401")) {
                    showMessageModal("Errore di Rete", "Impossibile connettersi ai server. Controlla la tua connessione o riprova più tardi.");
                }
                throw error;
            }
        }

        /**
         * Popola la sezione Hero con un elemento casuale di tendenza (film o serie TV).
         */
        async function populateHeroSection() {
            try {
                const data = await fetchData("/trending/all/week");
                if (data.results && data.results.length > 0) {
                    // Filtra per avere solo film o TV con backdrop e poster
                    const playableItems = data.results.filter(item =>
                        (item.media_type === 'movie' || item.media_type === 'tv') &&
                        item.backdrop_path && item.poster_path && (item.title || item.name)
                    );

                    if (playableItems.length > 0) {
                        heroItem = playableItems[Math.floor(Math.random() * playableItems.length)];

                        hero.classList.remove('hidden'); // Mostra la sezione Hero
                        heroImg.src = `${TMDB_IMAGE_BASE_URL}original${heroItem.backdrop_path}`;
                        heroTitle.textContent = heroItem.title || heroItem.name;
                        heroOverview.textContent = heroItem.overview || "Nessuna descrizione disponibile.";

                        heroPlay.onclick = () => {
                            showInfoModal(heroItem); // Apre il modal info per l'elemento hero
                        };
                        console.log("DEBUG VixStream: Sezione Hero popolata con:", heroItem.title || heroItem.name);
                    } else {
                        console.warn("DEBUG VixStream: Nessun elemento giocabile trovato per la sezione Hero.");
                        hero.classList.add('hidden'); // Nasconde la sezione Hero se non ci sono elementi validi
                    }
                }
            } catch (error) {
                console.error("DEBUG VixStream: Errore nel popolare la sezione Hero:", error);
                hero.classList.add('hidden'); // Nasconde la sezione Hero in caso di errore
            }
        }


        /**
         * Popola un carosello con film o serie TV.
         * @param {HTMLElement} container - L'elemento DOM in cui aggiungere il carosello.
         * @param {string} title - Il titolo del carosello.
         * @param {string} apiUrlPath - Il percorso API per recuperare i dati.
         */
        async function populateCarousel(container, title, apiUrlPath) {
            try {
                const data = await fetchData(apiUrlPath);
                if (data.results && data.results.length > 0) {
                    const carouselDiv = document.createElement('div');
                    carouselDiv.className = 'relative mb-8';

                    const carouselTitle = document.createElement('h3');
                    carouselTitle.className = 'text-2xl font-bold text-white mb-4 pl-4 md:pl-0';
                    carouselTitle.textContent = title;

                    const carouselTrack = document.createElement('div');
                    carouselTrack.className = 'carousel-track flex overflow-x-scroll scrollbar-hide py-2';

                    data.results.forEach(item => {
                        const card = createCard(item);
                        if (card) {
                            carouselTrack.appendChild(card);
                        }
                    });

                    const scrollLeftBtn = document.createElement('button');
                    scrollLeftBtn.className = 'scroll-button left-0 hidden md:flex';
                    scrollLeftBtn.innerHTML = '&#10094;'; // Carattere freccia sinistra
                    scrollLeftBtn.onclick = () => {
                        carouselTrack.scrollBy({ left: -carouselTrack.offsetWidth * 0.7, behavior: 'smooth' });
                    };

                    const scrollRightBtn = document.createElement('button');
                    scrollRightBtn.className = 'scroll-button right-0 hidden md:flex';
                    scrollRightBtn.innerHTML = '&#10095;'; // Carattere freccia destra
                    scrollRightBtn.onclick = () => {
                        carouselTrack.scrollBy({ left: carouselTrack.offsetWidth * 0.7, behavior: 'smooth' });
                    };

                    carouselDiv.appendChild(carouselTitle);
                    carouselDiv.appendChild(carouselTrack);
                    carouselDiv.appendChild(scrollLeftBtn);
                    carouselDiv.appendChild(scrollRightBtn);

                    container.appendChild(carouselDiv);
                    console.log(`DEBUG VixStream: Carosello "${title}" popolato.`);
                }
            } catch (error) {
                console.error(`DEBUG VixStream: Errore nel popolare il carosello "${title}":`, error);
            }
        }

        /**
         * Popola una griglia di generi.
         * @param {HTMLElement} container - L'elemento DOM in cui aggiungere i generi.
         * @param {string} type - 'movie' o 'tv'.
         */
        async function populateGenresGrid(container, type) {
            try {
                const data = await fetchData(`/genre/${type}/list`);
                if (data.genres && data.genres.length > 0) {
                    container.innerHTML = ''; // Pulisci la griglia prima di aggiungere
                    data.genres.forEach(genre => {
                        const genreButton = document.createElement('button');
                        genreButton.className = 'bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full transition-colors duration-300 shadow-md text-lg';
                        genreButton.textContent = genre.name;
                        genreButton.onclick = () => searchByGenre(genre.id, type, genre.name);
                        container.appendChild(genreButton);
                    });
                    console.log(`DEBUG VixStream: Griglia generi "${type}" popolata.`);
                }
            } catch (error) {
                console.error(`DEBUG VixStream: Errore nel popolare la griglia generi "${type}":`, error);
            }
        }

        /**
         * Effettua una ricerca per genere e mostra i risultati.
         * @param {number} genreId - L'ID del genere.
         * @param {string} type - 'movie' o 'tv'.
         * @param {string} genreName - Il nome del genere per il titolo della sezione.
         */
        async function searchByGenre(genreId, type, genreName) {
            clearSearchResults();
            showSection(searchSection);
            document.querySelector('#searchResults h2').textContent = `Risultati per: ${genreName}`;
            currentSearchQuery = ''; // Resetta la query di ricerca testuale
            currentSearchPage = 1;
            console.log(`DEBUG VixStream: Ricerca per genere: ${genreName} (${type}, ID: ${genreId})`);

            await fetchAndDisplayResults({
                path: `/discover/${type}`,
                params: { with_genres: genreId },
                append: false,
                queryType: 'genre',
                genreId: genreId,
                mediaType: type
            });
        }


        /**
         * Popola la homepage con vari caroselli.
         */
        async function populateHomepageCarousels() {
            sectionsEl.innerHTML = ''; // Pulisci i caroselli esistenti

            await populateCarousel(sectionsEl, "Di Tendenza Ora", "/trending/all/week");
            await populateCarousel(sectionsEl, "Film Popolari", "/movie/popular");
            await populateCarousel(sectionsEl, "Serie TV Popolari", "/tv/popular");
            await populateCarousel(sectionsEl, "Film Prossimamente", "/movie/upcoming");
            await populateCarousel(sectionsEl, "Film Più Votati", "/movie/top_rated");
            await populateCarousel(sectionsEl, "Serie TV Più Votate", "/tv/top_rated");
            console.log("DEBUG VixStream: Caroselli homepage popolati.");
        }

        /**
         * Gestisce la ricerca testuale e aggiorna la UI.
         */
        async function handleSearch() {
            const query = searchInput.value.trim();
            if (query === currentSearchQuery && currentSearchPage === 1) {
                return; // Non fare nulla se la query non è cambiata e siamo alla prima pagina
            }
            currentSearchQuery = query;
            currentSearchPage = 1; // Resetta la pagina per una nuova ricerca
            clearSearchResults(); // Pulisci i risultati precedenti
            showSection(searchSection);
            document.querySelector('#searchResults h2').textContent = `Risultati di Ricerca per "${query}"`;
            console.log(`DEBUG VixStream: Avvio ricerca testuale per: "${query}"`);

            await fetchAndDisplayResults({
                path: `/search/multi`,
                params: { query: query },
                append: false,
                queryType: 'text'
            });
        }

        /**
         * Funzione generica per recuperare e visualizzare i risultati (sia ricerca che generi).
         * @param {object} options - Opzioni per la ricerca.
         * @param {string} options.path - Il percorso API.
         * @param {object} options.params - Parametri aggiuntivi per la query.
         * @param {boolean} options.append - Se aggiungere o sovrascrivere i risultati.
         * @param {string} options.queryType - 'text' o 'genre'.
         * @param {number} [options.genreId] - ID del genere (solo per queryType 'genre').
         * @param {string} [options.mediaType] - 'movie' o 'tv' (solo per queryType 'genre').
         */
        async function fetchAndDisplayResults(options) {
            try {
                const { path, params, append, queryType, genreId, mediaType } = options;
                const data = await fetchData(path, { ...params, page: currentSearchPage });

                if (data.results && data.results.length > 0) {
                    if (!append) {
                        resultsGrid.innerHTML = ''; // Pulisci solo se non stiamo aggiungendo
                    }

                    data.results.forEach(item => {
                        const card = createCard(item);
                        if (card) {
                            resultsGrid.appendChild(card);
                        }
                    });

                    totalSearchPages = data.total_pages;
                    if (currentSearchPage < totalSearchPages) {
                        loadMoreResultsBtn.classList.remove('hidden');
                        // Aggiorna l'handler del pulsante "Carica Altri"
                        loadMoreResultsBtn.onclick = () => {
                            currentSearchPage++;
                            fetchAndDisplayResults({ ...options, append: true });
                        };
                    } else {
                        loadMoreResultsBtn.classList.add('hidden');
                    }
                    console.log(`DEBUG VixStream: Visualizzati ${data.results.length} risultati. Pagina ${currentSearchPage} di ${totalSearchPages}.`);
                } else {
                    if (!append) {
                        resultsGrid.innerHTML = '<p class="text-xl text-gray-400 col-span-full text-center">Nessun risultato trovato.</p>';
                    }
                    loadMoreResultsBtn.classList.add('hidden');
                    console.log("DEBUG VixStream: Nessun risultato trovato per la ricerca.");
                }
            } catch (error) {
                console.error("DEBUG VixStream: Errore nel recupero e visualizzazione dei risultati:", error);
                if (!append) {
                    resultsGrid.innerHTML = '<p class="text-xl text-red-400 col-span-full text-center">Si è verificato un errore durante il caricamento dei risultati.</p>';
                }
                loadMoreResultsBtn.classList.add('hidden');
            }
        }

        /**
         * Mostra il modal delle informazioni per un film o una serie TV.
         * @param {object} item - L'oggetto film o serie TV.
         */
        async function showInfoModal(item) {
            console.log("DEBUG VixStream: showInfoModal chiamato con item:", item); // Debug log
            console.log("DEBUG VixStream: item.id:", item.id, "item.media_type:", item.media_type); // Debug log

            if (!item || !item.id || !item.media_type) {
                showMessageModal("Errore", "Dettagli del contenuto non disponibili o tipo non riconosciuto.");
                console.error("DEBUG VixStream: Elemento non valido o incompleto passato a showInfoModal:", item);
                return;
            }

            const itemId = item.id;
            const itemType = item.media_type;

            console.log(`DEBUG VixStream: Tentando di recuperare dettagli per ID: ${itemId}, Tipo: ${itemType}`); // Debug log

            try {
                let details;
                // Imposta i selettori di stagione/episodio come nascosti di default
                tvSelectors.classList.add('hidden');
                seasonSelect.innerHTML = ''; // Pulisci le opzioni precedenti
                episodeSelect.innerHTML = ''; // Pulisci le opzioni precedenti

                if (itemType === 'movie') {
                    details = await fetchData(`/movie/${itemId}`);
                } else if (itemType === 'tv') {
                    details = await fetchData(`/tv/${itemId}`);
                    currentTvSeriesDetails = details; // Salva i dettagli completi della serie TV
                    populateSeasonEpisodeSelectors(details);
                    tvSelectors.classList.remove('hidden'); // Mostra i selettori solo per serie TV
                } else {
                    showMessageModal("Errore", "Tipo di contenuto non riconosciuto per mostrare i dettagli.");
                    console.error("DEBUG VixStream: Tipo di contenuto sconosciuto per showInfoModal:", itemType);
                    return;
                }

                // Popola il modal con i dettagli
                infoBgImg.src = `${TMDB_IMAGE_BASE_URL}original${details.backdrop_path}`;
                infoPoster.src = `${TMDB_IMAGE_BASE_URL}w500${details.poster_path}`;
                infoPosterMobile.src = `${TMDB_IMAGE_BASE_URL}w500${details.poster_path}`;
                infoTitle.textContent = details.title || details.name;
                infoOverview.textContent = details.overview || "Nessuna descrizione disponibile.";

                let metaText = '';
                if (itemType === 'movie') {
                    const releaseYear = details.release_date ? new Date(details.release_date).getFullYear() : 'N/A';
                    const runtime = details.runtime ? `${details.runtime} min` : 'N/A';
                    metaText = `${releaseYear} | ${runtime}`;
                } else if (itemType === 'tv') {
                    const firstAirYear = details.first_air_date ? new Date(details.first_air_date).getFullYear() : 'N/A';
                    const lastAirYear = details.last_air_date && details.first_air_date !== details.last_air_date ? new Date(details.last_air_date).getFullYear() : '';
                    const episodeCount = details.number_of_episodes ? `${details.number_of_episodes} episodi` : 'N/A';
                    const seasonCount = details.number_of_seasons ? `${details.number_of_seasons} stagioni` : 'N/A';
                    metaText = `${firstAirYear}${lastAirYear ? ` - ${lastAirYear}` : ''} | ${seasonCount} | ${episodeCount}`;
                }
                infoMeta.textContent = metaText;

                // Salva l'elemento corrente nel dataset del modal per riferimento futuro (es. per il player)
                // Usiamo JSON.stringify per salvare l'intero oggetto come stringa
                infoModal.dataset.currentItem = JSON.stringify({
                    id: itemId,
                    media_type: itemType,
                    title: details.title || details.name,
                    // Puoi aggiungere altre proprietà se necessarie per buildPlayerSrc
                });

                openModal(infoModal);
                console.log("DEBUG VixStream: Modal info popolato e aperto.");
            } catch (error) {
                console.error("DEBUG VixStream: Errore nel recupero dettagli per il modal info:", error);
                showMessageModal("Errore", "Impossibile caricare i dettagli del contenuto. Riprova più tardi.");
            }
        }

        /**
         * Popola i selettori di stagione ed episodio per una serie TV.
         * @param {object} tvDetails - I dettagli completi della serie TV.
         */
        function populateSeasonEpisodeSelectors(tvDetails) {
            seasonSelect.innerHTML = '';
            episodeSelect.innerHTML = ''; // Pulisci anche gli episodi inizialmente

            if (!tvDetails || !tvDetails.seasons || tvDetails.seasons.length === 0) {
                console.warn("DEBUG VixStream: Nessuna stagione disponibile per la serie TV:", tvDetails);
                return;
            }

            // Ordina le stagioni per numero (escludendo special season 0)
            const validSeasons = tvDetails.seasons
                .filter(season => season.season_number > 0)
                .sort((a, b) => a.season_number - b.season_number);

            if (validSeasons.length === 0) {
                console.warn("DEBUG VixStream: Nessuna stagione valida (escluse le speciali) disponibile per la serie TV.");
                return;
            }

            validSeasons.forEach(season => {
                const option = document.createElement('option');
                option.value = season.season_number;
                option.textContent = `Stagione ${season.season_number} (${season.episode_count || 0} episodi)`;
                seasonSelect.appendChild(option);
            });

            // Seleziona la prima stagione di default e carica i suoi episodi
            if (seasonSelect.options.length > 0) {
                seasonSelect.value = validSeasons[0].season_number;
                fetchEpisodesForSeason(tvDetails.id, validSeasons[0].season_number);
            }
        }

        /**
         * Recupera e popola gli episodi per una data stagione di una serie TV.
         * @param {number} tvId - L'ID della serie TV.
         * @param {number} seasonNumber - Il numero della stagione.
         */
        async function fetchEpisodesForSeason(tvId, seasonNumber) {
            episodeSelect.innerHTML = ''; // Pulisci gli episodi precedenti
            console.log(`DEBUG VixStream: Recupero episodi per TV ID: ${tvId}, Stagione: ${seasonNumber}`);
            try {
                const seasonDetails = await fetchData(`/tv/${tvId}/season/${seasonNumber}`);
                if (seasonDetails.episodes && seasonDetails.episodes.length > 0) {
                    seasonDetails.episodes.forEach(episode => {
                        const option = document.createElement('option');
                        option.value = episode.episode_number;
                        option.textContent = `Episodio ${episode.episode_number}: ${episode.name}`;
                        episodeSelect.appendChild(option);
                    });
                    console.log(`DEBUG VixStream: Popolati ${seasonDetails.episodes.length} episodi per la stagione ${seasonNumber}.`);
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Nessun episodio disponibile';
                    episodeSelect.appendChild(option);
                    console.warn(`DEBUG VixStream: Nessun episodio trovato per la stagione ${seasonNumber}.`);
                }
            } catch (error) {
                console.error(`DEBUG VixStream: Errore nel recupero degli episodi per la stagione ${seasonNumber}:`, error);
                showMessageModal("Errore", "Impossibile caricare gli episodi per questa stagione.");
            }
        }

        /**
         * Apre il player modal e carica il video.
         * @param {object} item - L'oggetto del film o della serie TV.
         */
        function openPlayer(item) {
            let srcInfo = null;
            if (item.media_type === 'movie') {
                srcInfo = buildPlayerSrc(item);
            } else if (item.media_type === 'tv') {
                const selectedSeason = seasonSelect.value;
                const selectedEpisode = episodeSelect.value;

                if (!selectedSeason || !selectedEpisode || selectedSeason === "" || selectedEpisode === "") {
                    showMessageModal("Selezione Obbligatoria", "Seleziona una stagione e un episodio prima di riprodurre.");
                    return;
                }
                srcInfo = buildPlayerSrc(item, parseInt(selectedSeason), parseInt(selectedEpisode));
            } else {
                showMessageModal("Errore di Riproduzione", "Tipo di contenuto non supportato.");
                return;
            }

            if (srcInfo && srcInfo.url) {
                playerFrame.src = srcInfo.url;
                openModal(playerModal);
                console.log("DEBUG VixStream: Player aperto con URL:", srcInfo.url);
            } else {
                console.error("DEBUG VixStream: Impossibile ottenere l'URL per il player:", item);
                // Il messaggio di errore è già gestito da buildPlayerSrc
            }
        }


        // --- LISTENER EVENTI PRINCIPALI ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DEBUG VixStream: DOM caricato.");
            populateHeroSection();
            populateHomepageCarousels();
            // Inizializza con la homepage attiva
            showSection(homepageSection, homeLink);
        });

        // Navigazione
        homeLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(homepageSection, homeLink);
            populateHomepageCarousels(); // Ricarica i caroselli se necessario
            clearSearchResults(); // Pulisci la ricerca quando torni alla home
            searchInput.value = ''; // Pulisci input di ricerca
        });

        moviesLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(moviesSection, moviesLink);
            populateCarousel(movieCarouselsContainer, "Film Popolari", "/movie/popular");
            populateCarousel(movieCarouselsContainer, "Film Prossimamente", "/movie/upcoming");
            populateCarousel(movieCarouselsContainer, "Film Più Votati", "/movie/top_rated");
            populateGenresGrid(movieGenresGrid, 'movie');
            clearSearchResults();
            searchInput.value = '';
        });

        tvShowsLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(tvShowsSection, tvShowsLink);
            populateCarousel(tvShowCarouselsContainer, "Serie TV Popolari", "/tv/popular");
            populateCarousel(tvShowCarouselsContainer, "Serie TV Più Votate", "/tv/top_rated");
            populateGenresGrid(tvShowGenresGrid, 'tv');
            clearSearchResults();
            searchInput.value = '';
        });


        // Ricerca
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(handleSearch, 500); // Ritardo di 500ms per la ricerca
        });

        // Pulsanti di chiusura dei modal
        closeInfoBtn.addEventListener('click', closeAllModals);
        closePlayerBtn.addEventListener('click', () => {
            playerFrame.src = ""; // Ferma il video
            closeAllModals();
        });
        closeMessageModalBtn.addEventListener('click', closeAllModals);
        modalBackdrop.addEventListener('click', closeAllModals); // Chiudi modal cliccando sullo sfondo

        // Pulsante Play nel modal info
        playBtn.addEventListener('click', () => {
            const currentItemData = infoModal.dataset.currentItem;
            if (currentItemData) {
                const currentItem = JSON.parse(currentItemData);
                openPlayer(currentItem);
            } else {
                showMessageModal("Errore", "Impossibile recuperare i dati del contenuto per la riproduzione.");
                console.error("DEBUG VixStream: currentItem non trovato nel dataset del modal.");
            }
        });

        // Pulsante Play nella sezione Hero
        heroPlay.addEventListener('click', () => {
            if (heroItem) {
                openPlayer(heroItem);
            } else {
                showMessageModal("Errore", "Contenuto Hero non pronto per la riproduzione.");
                console.error("DEBUG VixStream: heroItem non disponibile per la riproduzione.");
            }
        });

        // Gestione della tastiera per i modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (!playerModal.classList.contains('hidden')) {
                    playerFrame.src = ""; // Ferma il video
                }
                closeAllModals();
            }
        });

    </script>
</body>
</html>
